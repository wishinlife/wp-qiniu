jQuery(function(a){a(document).ready(function(){var h=a("#wp-qiniu-plugin-url").val(),i=a("#wp-qiniu-style-split-char").val(),j=a("#wp-qiniu-thumbnail-style").val(),l=a("#wp-qiniu-watermark-style").val(),b=a("#wp-qiniu-storage-domain").val(),g=a("#wp-admin-ajax-url").val(),k=a("#wp_qiniu_ajax_nonce").val(),d=(j)?i+j:"?imageView2/1/w/100/h/100",c=(l)?i+l:"";var f=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"upload-pickfiles",uptoken_func:function(n){var m="";a.ajax({type:"GET",url:g,async:false,data:{action:"wp_qiniu_get_uptoken",pid:n.pid,fname:n.name,nonce:k},error:function(o){alert("获取文件上传token失败！")},success:function(p){if(p.status==="success"){if(p.exist){var o=confirm("已存在同名文件，覆盖原有文件？");if(o){n.overwrite=true}else{n.canceled=true}}else{n.overwrite=false}n.fname=p.fname;m=p.uptoken}else{alert(p.error)}}});return m},get_new_uptoken:true,domain:b,container:"upload-container",max_file_size:"512mb",flash_swf_url:"../wp-includes/js/plupload/plupload.flash.swf",max_retries:3,dragdrop:true,drop_element:"upload-pickfiles",chunk_size:"4mb",auto_start:true,multi_selection:true,init:{FilesAdded:function(m,o){a("#upload-detail").show();a("#upload-success").hide();var p=a("#load-more"),n=p.attr("data-pid"),q=p.attr("data-current-path");plupload.each(o,function(s){s.pid=n;s.path=q;s.overwrite=false;s.canceled=false;var r=new e(s,"fsUploadProgress");r.setStatus("等待...");r.bindUploadCancel(m)})},BeforeUpload:function(m,o){var n=new e(o,"fsUploadProgress");if(o.canceled){n.fileProgressWrapper.find("td:eq(2) .progressCancel").click();return false}else{var p=plupload.parseSize(this.getOption("chunk_size"));if(m.runtime==="html5"&&p){n.setChunkProgess(p)}}},UploadProgress:function(m,o){var n=new e(o,"fsUploadProgress");var p=plupload.parseSize(this.getOption("chunk_size"));n.setProgress(o.percent+"%",o.speed,p)},UploadComplete:function(){a("#upload-success").show()},FileUploaded:function(m,o,p){if(o.overwrite){a('div.file-on-qiniu[data-file-name="'+o.name+'"]').each(function(){if(a(this).attr("data-file-type")!="dir"){a(this).remove()}})}var n=new e(o,"fsUploadProgress");n.setComplete(m,p.response)},Error:function(m,p,o){a("#upload-detail").show();var n=new e(p.file,"fsUploadProgress");n.setError();n.setStatus(o)},Key:function(m,n){return n.path+n.fname}}});a("#upload-pickfiles").on("dragenter",function(m){m.preventDefault();a("#upload-pickfiles").addClass("draging");m.stopPropagation()}).on("drop",function(m){m.preventDefault();a("#upload-pickfiles").removeClass("draging");m.stopPropagation()}).on("dragleave",function(m){m.preventDefault();a("#upload-pickfiles").removeClass("draging");m.stopPropagation()}).on("dragover",function(m){m.preventDefault();a("#upload-pickfiles").addClass("draging");m.stopPropagation()});a("body").on("click","table button.btn",function(){a(this).parents("tr").next().toggle()});function e(o,p){this.fileProgressID=o.id;this.file=o;this.opacity=100;this.height=0;this.fileProgressWrapper=a("#"+this.fileProgressID);if(!this.fileProgressWrapper.length){this.fileProgressWrapper=a("<tr></tr>");var y=this.fileProgressWrapper;y.attr("id",this.fileProgressID).addClass("progressContainer");var r=a("<td/>");r.addClass("progressName").text(o.name);var q=plupload.formatSize(o.size).toUpperCase();var s=a("<td/>");s.addClass("progressFileSize").text(q);var w=a("<td colspan='2'/>");var n=a("<div/>");n.addClass("info");var m=a("<div/>");m.addClass("progress progress-striped");var t=a("<div/>");t.addClass("progress-bar progress-bar-info").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%");var u=a('<span class="sr-only" />');u.text(q);var v=a('<a href=javascript:; title="取消上传"><span/></a>');v.show().addClass("progressCancel");t.append(u);m.append(t);n.append(m);n.append(v);var x=a('<div class="status text-center"/>');n.append(x);w.append(n);y.append(r);y.append(s);y.append(w);a("#"+p).append(y)}else{this.reset()}this.height=this.fileProgressWrapper.offset().top;this.setTimer(null)}e.prototype.setTimer=function(m){this.fileProgressWrapper.FP_TIMER=m};e.prototype.getTimer=function(){return this.fileProgressWrapper.FP_TIMER||null};e.prototype.reset=function(){this.fileProgressWrapper.attr("class","progressContainer");this.fileProgressWrapper.find("td .progress .progress-bar-info").attr("aria-valuenow",0).width("0%").find("span").text("");this.appear()};e.prototype.setChunkProgess=function(u){var v=Math.ceil(this.file.size/u);if(v===1){return false}var o=a('<button class="btn btn-default button">查看分块上传进度</button>');var r=a('<tr class="chunk-status-tr"><td colspan=3></td></tr>');var s=a("<div/>");for(var p=1;p<=v;p++){var n=a('<div class="col-md-2"/>');var m=a('<div class="progress progress-striped"></div>');var q=a("<div/>");q.addClass("progress-bar progress-bar-info text-left").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%").attr("id",this.file.id+"_"+p).text("");var t=a("<span/>");t.addClass("chunk-status").text();m.append(q);m.append(t);n.append(m);s.append(n)}if(!this.fileProgressWrapper.find("td:eq(2) .btn-default").length){this.fileProgressWrapper.find("td>div").append(o)}r.hide().find("td").append(s);r.insertAfter(this.fileProgressWrapper)};e.prototype.setProgress=function(B,q,A){this.fileProgressWrapper.attr("class","progressContainer green");var r=this.file;var n=r.loaded;var C=plupload.formatSize(n).toUpperCase();var x=plupload.formatSize(q).toUpperCase();var t=this.fileProgressWrapper.find("td .progress").find(".progress-bar-info");if(this.fileProgressWrapper.find(".status").text()==="已取消上传"){return}this.fileProgressWrapper.find(".status").text("已上传: "+C+" 上传速度： "+x+"/s");B=parseInt(B,10);if(r.status!==plupload.DONE&&B===100){B=99}t.attr("aria-valuenow",B).css("width",B+"%");if(A){var z=Math.ceil(r.size/A);if(z===1){return false}var p=Math.ceil(n/A);var w,y;for(var u=0;u<p;u++){w=a("#"+r.id+"_"+u);w.width("100%").removeClass().addClass("alert-success").attr("aria-valuenow",100);y="块"+u+"上传进度100%";w.next().html(y)}var s=a("#"+r.id+"_"+p);var v;if(p<z){if(n%A){v=((n%A)/A*100).toFixed(2)}else{v=100;s.removeClass().addClass("alert-success")}}else{var o=r.size-A*(z-1);var m=r.size-n;if(m%o){v=((n%A)/o*100).toFixed(2)}else{v=100;s.removeClass().addClass("alert-success")}}s.width(v+"%");s.attr("aria-valuenow",v);y="块"+p+"上传进度"+v+"%";s.next().html(y)}this.appear()};e.prototype.setComplete=function(w,F){var t=this.fileProgressWrapper.find("td:eq(2)"),v=t.find(".progress");var G=a.parseJSON(F);var H=w.getOption("domain");var p,A;if(G.url){p=encodeURI(G.url)}else{p=H+encodeURI(G.key)}A="<div><strong>原文件链接：:</strong><a href="+p+" target='_blank' > "+H+G.key+"</a></div><div class=hash><strong>文件Hash值：</strong>"+G.hash+"</div><div class=hash><strong>文件Key：</strong>"+G.key+"</div><br/><div><strong></strong></div>";v.html(A).removeClass().next().next(".status").hide();t.find(".progressCancel").hide();t.find(".btn").parents("tr").next().remove();t.find(".btn").remove();var s=this.fileProgressWrapper.find(".progressName");this.fileProgressWrapper.addClass("success");var E=a('<div class="Wrapper"/>');var z=a('<div class="imgWrapper col-md-3"/>');var u=a('<a class="linkWrapper" target="_blank"/>');var r=a('<img src="'+h+'img/loading.gif"/>');s.append(E);var D=".|jpg|jpeg|png|gif|bmp|",n=".|asf|avi|flv|mkv|mov|mp4|wmv|3gp|3g2|mpeg|ts|rm|rmvb|m3u8|",C=".|ogg|mp3|wma|wav|mp3pro|mid|midi|",o=G.fname.substring(G.fname.lastIndexOf(".")+1).toLowerCase();if(D.indexOf("|"+o+"|")>0){o="image"}else{if(n.indexOf("|"+o+"|")>0){o="video"}else{if(C.indexOf("|"+o+"|")>0){o="audio"}else{o="file"}}}if(o!="image"&&o!="video"){r.attr("src",h+"img/"+o+".png");E.addClass("default");z.append(r);E.append(z)}else{if(o=="image"){u.append(r);z.append(u);E.append(z);u.attr("href",p).attr("title","查看原图");r.attr("src",H+encodeURI(G.key)+d)}else{r.attr("src",h+"img/"+o+".png");E.addClass("default");z.append(r);E.append(z)}var y=a('<div class="infoWrapper col-md-6"></div>');if(c&&o=="image"){var x=a('<a href="" target="_blank">查看水印图片</a>');x.attr("href",H+encodeURI(G.key)+c).attr("title","查看水印图片");y.append(x)}var q=a("<div/>");var B='<div>格式：<span class="origin-format">'+G.format+'</span></div><div>宽度：<span class="orgin-width">'+G.width+'px</span></div><div>高度：<span class="origin-height">'+G.height+"px</span></div>";q.html(B);y.append(q);E.append(y)}var m='<div class="file-on-qiniu" data-file-name="'+G.fname+'" data-file-type="'+o+'" data-file-id="'+G.id+'" data-file-mime="'+G.mimeType+'">';m+='<div class="file-thumbnail">';if(o=="image"){m+='<img src="'+H+encodeURI(G.key)+d+'" />'}else{m+='<img src="'+h+"img/"+o+'.png" />'}m+="</div>";m+='<div class="file-name"><div class="file-text">';m+=G.fname;m+="</div></div>";m+="</div>";a("#files-on-qiniu").append(m)};e.prototype.setError=function(){this.fileProgressWrapper.find("td:eq(2)").attr("class","text-warning");this.fileProgressWrapper.find("td:eq(2) .progress").css("width",0).hide();this.fileProgressWrapper.find("button").hide();this.fileProgressWrapper.next(".chunk-status-tr").hide();this.fileProgressWrapper.addClass("danger")};e.prototype.setCancelled=function(n){var m="progressContainer";if(!n){m+=" red"}this.fileProgressWrapper.attr("class",m);this.fileProgressWrapper.find("td .progress").remove();this.fileProgressWrapper.find("td:eq(2) .btn-default").hide();this.fileProgressWrapper.find("td:eq(2) .progressCancel").hide();this.fileProgressWrapper.next(".chunk-status-tr").hide()};e.prototype.setStatus=function(n,m){if(!m){this.fileProgressWrapper.find(".status").text(n).attr("class","status text-left")}};e.prototype.bindUploadCancel=function(m){var n=this;if(m){n.fileProgressWrapper.find("td:eq(2) .progressCancel").on("click",function(){n.setCancelled(false);n.setStatus("已取消上传");n.fileProgressWrapper.find(".status").css("left","0");m.removeFile(n.file);n.fileProgressWrapper.addClass("warning")})}};e.prototype.appear=function(){if(this.getTimer()!==null){clearTimeout(this.getTimer());this.setTimer(null)}if(this.fileProgressWrapper[0].filters){try{this.fileProgressWrapper[0].filters.item("DXImageTransform.Microsoft.Alpha").opacity=100}catch(m){this.fileProgressWrapper.css("filter","progid:DXImageTransform.Microsoft.Alpha(opacity=100)")}}else{this.fileProgressWrapper.css("opacity",1)}this.fileProgressWrapper.css("height","");this.height=this.fileProgressWrapper.offset().top;this.opacity=100;this.fileProgressWrapper.show()}})});